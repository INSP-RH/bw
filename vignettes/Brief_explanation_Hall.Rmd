---
title: "Brief explanation on Hall model and inputs"
author: "Dalia Camacho García Formentí  \\  Rodrigo Zepeda Tello"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Why should I use this model?}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: Referencias.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
require(ggplot2)
require(bw)
knitr::opts_chunk$set(fig.width = 8, fig.height = 4)
```

### Reasons to use Hall model

\noindent Hall's model is a biomathematical model to predict changes in body weight. There are two models, one for adults [@T7] and the other one for children.[@hall2013dynamics] 

The main advantage of the model is that weight change is nonlinear and is based on physiological processes. Therefore, it does not follow rules such as *1 kg for every 250 kcals*. These rules do not represent the physiological process correctly and may lead to a series of problems, such as:

+ **Weight change is not immediate:** Take for example that weight change is modelled by a loss of *1 kg for every 250 kcals* and a certain individual reduces its total energy intake by 500 kcal. Under this model, weight change is immediate and it can be represented by the following graph: 

```{r, echo = FALSE, warning=FALSE}
data1 <- data.frame(Day = c(-5:0,0:5), Weight = c(rep(80, 6), rep(NA, 6)))
data2 <- data.frame(Day = c(-5:0,0:5), Weight = c(rep(NA, 6), rep(78, 6)))

ggplot(data1, aes(x = Day, y = Weight)) + 
  geom_line(color = "deepskyblue3") + 
  geom_line(data = data2, color = "deepskyblue3") +
  annotate("text", x = -2, y = 80.2, label = "Before reducing caloric intake") +
  annotate("text", x = 2, y = 78.2, label = "After 500 kcal reduction") +
  theme_classic()  + 
  ggtitle("Immediate change in body weight  according to a loss of 1 kg for every 250 kcals")

```

However, weight change is not immediate.

+ **Weight change is dependent on age, sex, and initial body mass index (BMI)**. Under the same change in caloric intake, a young woman with obesity weighing $100$ kg will have a different change in body weight than an underweight grown man weighing $40$ kg. Linear rules do not consider physiological differences between individuals.

+ **Some linear models could lead to zero weight.** Some linear models are dependent on time. Take for example a change of *1 kg/year for every 250 kcals*. If the model is meant to predict weight in the long run some individuals might end weighing zero weight.

```{r,echo = FALSE, warning=FALSE}
data1 <- data.frame(Año = 0:30, Peso = seq(60,0, length.out = 31))

ggplot(data1, aes(x = Año, y = Peso)) + 
  geom_line(color = "deepskyblue3") +
  theme_classic() + 
  ggtitle("Weight trajectory for an individual that reduced 500 kcal from their TEI. \n Under a loss of 1 kg/year for every 250 kcals")

```

+ **Weight change is dependent on the previous weight change trajectory** Take for example a person was consuming 500 kcals more than those needed to maintain current weight. This individual would gain weight even if a reduction of 250 kcals on their current diet was going to take place. If we only consider the model given by a loss of  *1 kg for every 250 kcals*, this individual would lose one kg, even if the caloric intake to maintain weight was exceeded by 250 kcals.


Hall model can be used to avoid problems as the ones stated before. Hall considers weight change depends on physiological processes and individual characteristics such as weight, sex, age, and height (a clear description of the inputs will be given later). Weight change obtained from Hall's model is not immediate, and if no further changes in caloric intake take place, body weight will stabilize over time. An example of a weight change trajectory under Hall model is shown in the following graph:

```{r,echo = FALSE}
trajectory <- adult_weight(80, 1.8, 43, "male", c(0, rep(-250, 3650)), days = 3651)
data1 <- data.frame(Día = 0:3650, Peso = trajectory$Body_Weight[,1:3651])

ggplot(data1, aes(x = Día, y = Peso)) + 
  geom_line(color = "deepskyblue3") +
  theme_classic() + 
  ggtitle("Weight trajectory for a 43 year old man with a height of 1.8m, initial body weight of 80kg, who reduced 500 kcals from his TEI")


```

### Brief explanation on Hall's equations

\noindent The main idea of Hall's model is that body weight $BW(t)$ at a given time $t$ is the sum of four components: lean mass $L(t)$, fat mass $F(t)$, glycogen $g(t)$, and extracellular fluid $ECF(t)$:

\begin{equation}\label{bw}
\overbrace{BW(t)}^{\textrm{Weight}} = \underbrace{F(t)}_{\textrm{Fat}} + \overbrace{L(t)}^{\textrm{Lean}} + \underbrace{G(t)}_{\textrm{Glycogen}} + \overbrace{ECF(t)}^{\textrm{Extracellular Fluid}}
\end{equation}

Lean mass, fat mass, and glycogen are interrelated, meanwhile the extracellular fluid has its own dynamic. Hall model's equations are congruent with the energy conservation law. Changes in weight are therefore determined by:


+ Energy intake ($EI$), 
+ Energy expenditure ($EE$),
+ Glycogen reserve ($G$).


Changes in lean and fat mass are given by changes in intake, expenditure, and glycogen. An increase or decrease in body weight depends on the difference between intake and expenditure. A fraction of the change in weight $p$ will correspond to the change in lean mass and the remaining fraction $(1-p)$ will correspond to changes in fat mass. The corresponding equations are:

\begin{equation}\nonumber
\overbrace{\dfrac{dL}{dt}}^{\textrm{Change in lean mass}} = \underbrace{p}_{\textrm{Fraction}} \overbrace{\frac{\Big( EI - EE - \rho_G \frac{dG}{dt}\Big)}{\rho_L}}^{\textrm{Energy Intake} - \textrm{Expenditure+Storage}}
\end{equation}

\begin{equation}\nonumber
\overbrace{\dfrac{dF}{dt}}^{\textrm{Change in fat mass}} = \underbrace{(1-p)}_{\textrm{Remaining fraction}} \overbrace{\frac{\Big( EI - EE - \rho_G \frac{dG}{dt}\Big)}{\rho_L}}^{\textrm{Energy Intake} - \textrm{xpenditure+Storage}}
\end{equation}

Changes in glycogen are determined by the proportion of energy consumption from carbohidrates $CI$:

\begin{equation}
\overbrace{\dfrac{dG}{dt}}^{\textrm{Change in glycogen}} = \underbrace{\frac{1}{\rho_G} \Big( CI - k_G G^2\Big)}_{\textrm{Carbohydrates and constant parameters}},
\end{equation}

Finally, the equation for extracellular fluid depends on sodium intake and carbohidrates consumed:
\begin{equation}\nonumber
\overbrace{\dfrac{dECF}{dt}}^{\textrm{Change in fluid}} = \overbrace{\frac{ \Big( \Delta Na_{diet} + \xi_{Na}(ECF - ECF_{init}) - \xi_{CI} (1 - \frac{CI}{CI_{b}}) \Big)}{Na}.}^{\textrm{Depends on changes in sodium and carbohidrate intake.}}
\end{equation}


To summarize: weight is divided into four components: lean mass, fat mass, glycogen, and extracellular fluid:

\begin{equation}\nonumber
\overbrace{BW(t)}^{\textrm{Weight}} = \underbrace{F(t)}_{\textrm{Fat}} + \overbrace{L(t)}^{\textrm{Lean}} + \underbrace{G(t)}_{\textrm{Glycogen}} + \overbrace{ECF(t)}^{\textrm{Extracellular fluid}}
\end{equation}

### How to solve this system? 

\noindent Equations on this model are known as ordinary differential equations (ODE). In most cases this kind of equations cannot be solved analytically. Therefore, numerical methods are often used. 

The <tt>R</tt> package <tt>bw</tt>  is  an implementation of Hall's model.[@R2015] If you use our software we ask you to reference it as it appears on the bibliography. [@HallR] The inputs required for the model are: <tt>weight</tt>, <tt>age</tt>, <tt>sex</tt>, <tt>height</tt>,  <tt>change in kcals</tt> and <tt>change in sodium</tt>. All these elements are needed to run Hall model. A series of additional variables can improve the estimation, these are: <tt>physical activity</tt>, <tt>\% of baseline carbohydrate intake</tt>, <tt> \% of carbohydrate intake after change in diet</tt>, <tt>baseline energy intake</tt>. If these are unknown, Hall model can still work.

The model is constructed for individuals, therefore the best input for population estimates requires representative individual-level data. If this is not the case approximate estimations can be calculated as well.


+ If stratified averages (at least by sex) are available, these can be taken as inputs for the model. Jensen's inequality guarantees that the bias from the model is an underestimation of thw change. Therefore when modelling weight loss, final weight will be overestimated, while under weight gaine the final weight will be underestimated. 

+ If averages and a covariance matrix for the variables <tt>weight</tt>, <tt>age</tt>, <tt>height</tt>, <tt>change in kcal</tt>, and <tt>change in sodium</tt> are available, the delta method, a statistical technique, can be used to reduce bias in the estimation. 
+ If additional data such as kurtosis, skewness, quantiles, centiles are available better estimates can be derived. 


To summarize if only averages are available change in weight will be underestimated. If more information is available better estimates can be achieved, the best estimates will be obtained when individual-level data is available. If you want to further discuss the inputs of the model according to the data you have, you can send us an e-mail. 

### The package <tt>bw</tt>

\noindent We have an <tt>R</tt> package that has Hall model already programmed. In this section we explain how to use it. To run the model only the basics of <tt>R</tt> are needed (several free online courses are available at [Coursera](https://www.coursera.org/) , [edX](https://www.edx.org/) and [Code School](https://www.codeschool.com/courses/try-r)). 

The following instruction downloads our <tt>R</tt> package from github:

```{r,eval = FALSE}
if (!require(devtools)){install.packages("devtools")}
devtools::install_github("INSP-RH/bw", 
                         build_vignettes = TRUE)
```

For the adult model specify weight, height, sex, age, and change in energy intake and in sodium:

```{r,eval = TRUE}
# Individual characteristics
weight    <- 80
height    <- 1.8
age       <- 32
sex       <- "female" #"female" or "male"

# Change in energy intake
days    <- 365*10 # Days to run the model
deltaEI <- c(0, rep(-200, (days-1)))


# Change in sodium
deltaNA <- c(0, rep(-10, (days-1))) #Change in sodium (mg)

```

To run the model use ``bw::adult\_weight'':

```{r,}
trajectory <- adult_weight(bw=weight, ht= height, 
                           age=age, sex=sex,
                           EIchange = deltaEI,
                           NAchange = deltaNA,
                           days = days)
```

The body weight depends on each day. For day 30:

```{r,}
trajectory$Body_Weight[30]
```

To graph the trajectory use:
```{r,}
model_plot(trajectory, plotvars = "Body_Weight")
```

For more information on the package you can read the vignette:
```{r,eval = FALSE}
browseVignettes("bw")
```

Or the help command:
```{r,eval = FALSE}
??bw::adult_weight
```

Please, cite our package whenever you use it.[@HallR]

# References

